<!DOCTYPE html>

<html>

	<head>
		<link href="css/index.css" rel="stylesheet" type="text/css"/>

        <!-- Script will click the login button when you press enter -->
        <script>
            document
                    .addEventListener("keyup", function(event) {
                        event.preventDefault();
                        if(event.keyCode == 13) {
                            document.getElementById("login").click();
                        }
                    });
        </script>

        <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
        <link rel="stylesheet" href="css/themes/default/style.min.css" />
	</head>


	<body>

    <!-- Contains buttons for use-->
        <header>
            <form>
                <div class="container">
                    <div><input type="button" id="newConnection" value="New Connection" class="btn"></div>
                    <div><input type="button" id="testTree" value="Test Tree" class="btn"></div>
                    <div><input type="button" id="webdav" value="Web Dav" class="btn"></div>
                    <div><input type="button" value="Connection History" id="connection" class="btn"></div>
                    <div><input type="button" value="Bookmarks" id="bookmark" class="btn"></div>
                </div>

            </form>
        </header>

		<form id="frm1">
            <fieldset id="fileForm">

                <legend>File Information</legend>

               <!-- <label class="label" for="localPath"> Local Path </label>
                <input type="text" id="localPath" value="">
                <br><br>

                <label class="label" for="remotePath"> Remote Path </label>
                <input type="text" id="remotePath" value=""> -->

                <div id="jstree">

                    <ul id="main">

                    </ul>
                </div>

            </fieldset>

            <fieldset id="userInfo">

                <legend>User Info</legend>

                <label class="label" for="username"> Username </label>
                <input type="text" id="username" name="name" value="" autofocus>
                <br><br>

                <label class="label" for="password"> Password </label>
                <input type="password" id="password" name="pass">
                <br><br>

                <label class="label" for="serverName"> Server Name </label>
                <input type="text" id="serverName" name="server" value="">
                <br><br>

                <label class="label" for="port"> Port </label>
                <input type="text" id="port" size="10">
                <br><br>

                <label class="label">&nbsp;</label>
                <input type="button" class="loginButton" id="login" onclick="loginFunction(getLoginInfo())" value="Log In">
                <div id="loginText"></div>

            </fieldset>

            <br><br>

            <input type="button" id="tryUpload"      onclick="selectUpload()"    value="Upload">
            <input type="button" id="tryDownload"    onclick="selectDownload()"  value="Download">

            <br><br>

            <textarea id="area" cols="100" rows="15" disabled></textarea>



		    </form>

        <footer>
            <div id="myProgress">
                <div id="myBar">
                    <div id="progressLabel">0%</div>
                </div>
            </div>

            <div id="numberOfItems">

            </div>
        </footer>

    <script src="js/index.js"></script>
    <script src="js/indexButtons.js"></script>

    <script>

        var filesystem = require("fs");

        var _getAllFilesFromFolder = function (dir) {
            var results1 = [];

            filesystem.readdirSync(dir).forEach(function (file) {
                var fullDir = dir + file;

                try {
                    var stats = filesystem.statSync(fullDir);

                    if (stats.isFile()) {
                        results1.push([file, "jstree-file", fullDir, ""]);
                    }
                    else if (stats.isDirectory()) {
                        var children = _getFilesSecondLayer(fullDir + "/");
                        results1.push([file, "", fullDir, children]);
                    }
                }
                catch(err){
                    results1.push([file, "jstree-file", fullDir, "", dir]);
                }
            });

            return results1;
        };

        var _getFilesSecondLayer = function(dir){
            var results = [];

            filesystem.readdirSync(dir).forEach(function (file){
                var fullDir = dir + file;

                try {
                    var stats = filesystem.statSync(fullDir);

                    if (stats.isFile()) {
                        results.push([file, "jstree-file", fullDir, "", dir]);
                    }
                    else if (stats.isDirectory()) {

                        results.push([file, "", fullDir, "", dir]);
                    }
                }
                catch(err){
                    results.push([file, "jstree-file", fullDir, "", dir]);
                }

            })

            return results;
        }


        var $ = require("jquery");
        //console.log(results);

        $(document).ready(function () {
                var result = _getAllFilesFromFolder("C://");
                var jsonContent = [];

                for (i = 0; i < result.length; i++) {

                    var obj = {text: result[i][0], icon: result[i][1], id: result[i][2], parent: "#"};
                    jsonContent.push(obj);

                    // if the data is a directory it will create the children for it
                    if(result[i][3] != ""){
                        var temp = result[i][3];
                        for(j = 0; j < temp.length; j++){
                            var child = {text: temp[j][0], icon: temp[j][1], id: temp[j][2], parent: obj.id};
                            jsonContent.push(child);
                        }
                    }
                }

                $(function () {
                    $('#jstree').jstree({
                        core: {
                            data: jsonContent,
                            check_callback: true
                        },
                        plugins: ["dnd", "sort"]
                    });

                    $('#jstree').on("changed.jstree", function (e, data) {
                        console.log(data.selected);
                    });

                    // TODO In progress: Load nodes when folder is opened
                    $('#jstree').on("open_node.jstree", function(e, data){

                        var newChildren = _getAllFilesFromFolder(data.node.id + "/");

                        for(i = 0; i < newChildren.length; i++){

                            if(newChildren[i][3] != ""){
                                var temp = newChildren[i][3];

                                for(j = 0; j < temp.length; j++){
                                    var subs = temp[j][4].substring(0, temp[j][4].length-1);

                                    var child = {text: temp[j][0], icon: temp[j][1], id: temp[j][2]};

                                    if(!($('#jstree').jstree(true).get_node(child.id))){
                                        $('#jstree').jstree('create_node', subs, child);
                                    }


                                }
                            }
                        }
                    });

                    $(document).on('dnd_start.vakata', function(e, data){
                        console.log(data.data.nodes[0]);
                    });
                    $(document).on('dnd_stop.vakata', function(e, data){
                        var curNode = $('#jstree').jstree(true).get_node(data.data.nodes[0]);
                        var oldPath = curNode.id;

                        var newId = curNode.parent + "/" + curNode.text;
                        $('#jstree').jstree(true).set_id(curNode, newId);

                        filesystem.rename(oldPath, newId);

                    });
                });



            }
        )

    </script>

    <script src="js/jstree.min.js"></script>

	</body>



</html>